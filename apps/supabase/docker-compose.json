{
  "services": [
    {
      "name": "kong",
      "image": "kong:2.8.1",
      "environment": {
        "KONG_DATABASE": "off",
        "KONG_DECLARATIVE_CONFIG": "/var/lib/kong/kong.yml",
        "KONG_DNS_ORDER": "LAST,A,CNAME",
        "KONG_PLUGINS": "request-transformer,cors,key-auth,acl,basic-auth",
        "KONG_NGINX_PROXY_PROXY_BUFFER_SIZE": "160k",
        "KONG_NGINX_PROXY_PROXY_BUFFERS": "64 160k"
      },
      "volumes": [
        {
          "type": "bind",
          "source": "./volumes/api/kong.yml",
          "target": "/var/lib/kong/kong.yml"
        }
      ],
      "depends_on": [
        "auth"
      ],
      "ports": [
        {
          "containerPort": 8000,
          "hostPort": 8000
        },
        {
          "containerPort": 8443,
          "hostPort": 8443
        }
      ]
    },
    {
      "name": "auth",
      "image": "supabase/gotrue:v2.143.0",
      "environment": {
        "GOTRUE_API_HOST": "0.0.0.0",
        "GOTRUE_API_PORT": "9999",
        "GOTRUE_DB_DRIVER": "postgres",
        "GOTRUE_DB_DATABASE_URL": "postgres://supabase_auth_admin:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}",
        "GOTRUE_SITE_URL": "${SITE_URL}",
        "GOTRUE_URI_ALLOW_LIST": "${ADDITIONAL_REDIRECT_URLS}",
        "GOTRUE_DISABLE_SIGNUP": "${DISABLE_SIGNUP}",
        "GOTRUE_JWT_ADMIN_ROLES": "service_role",
        "GOTRUE_JWT_AUD": "authenticated",
        "GOTRUE_JWT_DEFAULT_GROUP_NAME": "authenticated",
        "GOTRUE_JWT_EXP": "${JWT_EXPIRY}",
        "GOTRUE_JWT_SECRET": "${JWT_SECRET}",
        "GOTRUE_EXTERNAL_EMAIL_ENABLED": "${ENABLE_EMAIL_SIGNUP}",
        "GOTRUE_EXTERNAL_ANONYMOUS_USERS_ENABLED": "${ENABLE_ANONYMOUS_USERS}",
        "GOTRUE_MAILER_AUTOCONFIRM": "${ENABLE_EMAIL_CONFIRMATIONS}",
        "GOTRUE_SMTP_ADMIN_EMAIL": "${SMTP_ADMIN_EMAIL}",
        "GOTRUE_SMTP_HOST": "${SMTP_HOST}",
        "GOTRUE_SMTP_PORT": "${SMTP_PORT}",
        "GOTRUE_SMTP_USER": "${SMTP_USER}",
        "GOTRUE_SMTP_PASS": "${SMTP_PASS}",
        "GOTRUE_SMTP_SENDER_NAME": "${SMTP_SENDER_NAME}"
      },
      "depends_on": [
        "db"
      ]
    },
    {
      "name": "rest",
      "image": "postgrest/postgrest:v12.0.1",
      "environment": {
        "PGRST_DB_URI": "postgres://authenticator:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}",
        "PGRST_DB_SCHEMAS": "${PGRST_DB_SCHEMAS}",
        "PGRST_DB_ANON_ROLE": "anon",
        "PGRST_JWT_SECRET": "${JWT_SECRET}",
        "PGRST_DB_USE_LEGACY_GUCS": "false",
        "PGRST_APP_SETTINGS_JWT_SECRET": "${JWT_SECRET}",
        "PGRST_APP_SETTINGS_JWT_EXP": "${JWT_EXPIRY}"
      },
      "depends_on": [
        "db"
      ]
    },
    {
      "name": "realtime",
      "image": "supabase/realtime:v2.25.50",
      "environment": {
        "PORT": "4000",
        "DB_HOST": "${POSTGRES_HOST}",
        "DB_PORT": "${POSTGRES_PORT}",
        "DB_USER": "supabase_realtime_admin",
        "DB_PASSWORD": "${POSTGRES_PASSWORD}",
        "DB_NAME": "${POSTGRES_DB}",
        "DB_AFTER_CONNECT_QUERY": "SET search_path TO _realtime",
        "DB_ENC_KEY": "supabaserealtime",
        "API_JWT_SECRET": "${JWT_SECRET}",
        "FLY_ALLOC_ID": "fly123",
        "FLY_APP_NAME": "realtime",
        "SECRET_KEY_BASE": "${SECRET_KEY_BASE}",
        "ERL_AFLAGS": "-proto_dist inet_tcp",
        "ENABLE_TAILSCALE": "false",
        "DNS_NODES": "''"
      },
      "depends_on": [
        "db"
      ],
      "command": [
        "sh",
        "-c",
        "/app/bin/migrate && /app/bin/realtime eval \"Realtime.Release.seeds(Realtime.Repo)\" && /app/bin/server"
      ]
    },
    {
      "name": "storage",
      "image": "supabase/storage-api:v0.43.11",
      "environment": {
        "ANON_KEY": "${ANON_KEY}",
        "SERVICE_KEY": "${SERVICE_ROLE_KEY}",
        "POSTGREST_URL": "http://rest:3000",
        "PGRST_JWT_SECRET": "${JWT_SECRET}",
        "DATABASE_URL": "postgres://supabase_storage_admin:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}",
        "FILE_SIZE_LIMIT": "52428800",
        "STORAGE_BACKEND": "file",
        "FILE_STORAGE_BACKEND_PATH": "/var/lib/storage",
        "TENANT_ID": "stub",
        "REGION": "stub",
        "GLOBAL_S3_BUCKET": "stub",
        "ENABLE_IMAGE_TRANSFORMATION": "true",
        "IMGPROXY_URL": "http://imgproxy:5001"
      },
      "volumes": [
        {
          "type": "bind",
          "source": "./volumes/storage",
          "target": "/var/lib/storage"
        }
      ],
      "depends_on": [
        "db",
        "rest",
        "imgproxy"
      ]
    },
    {
      "name": "imgproxy",
      "image": "darthsim/imgproxy:v3.8.0",
      "environment": {
        "IMGPROXY_BIND": "0.0.0.0:5001",
        "IMGPROXY_LOCAL_FILESYSTEM_ROOT": "/",
        "IMGPROXY_USE_ETAG": "true",
        "IMGPROXY_ENABLE_WEBP_DETECTION": "${IMGPROXY_ENABLE_WEBP_DETECTION}"
      },
      "volumes": [
        {
          "type": "bind",
          "source": "./volumes/storage",
          "target": "/var/lib/storage"
        }
      ]
    },
    {
      "name": "meta",
      "image": "supabase/postgres-meta:v0.75.0",
      "environment": {
        "PG_META_PORT": "8080",
        "PG_META_DB_HOST": "${POSTGRES_HOST}",
        "PG_META_DB_PORT": "${POSTGRES_PORT}",
        "PG_META_DB_NAME": "${POSTGRES_DB}",
        "PG_META_DB_USER": "supabase_postgres_meta",
        "PG_META_DB_PASSWORD": "${POSTGRES_PASSWORD}"
      },
      "depends_on": [
        "db"
      ]
    },
    {
      "name": "studio",
      "image": "supabase/studio:20241029-46e1e40",
      "environment": {
        "STUDIO_PG_META_URL": "http://meta:8080",
        "POSTGRES_PASSWORD": "${POSTGRES_PASSWORD}",
        "DEFAULT_ORGANIZATION_NAME": "${STUDIO_DEFAULT_ORGANIZATION}",
        "DEFAULT_PROJECT_NAME": "${STUDIO_DEFAULT_PROJECT}",
        "SUPABASE_URL": "http://kong:8000",
        "SUPABASE_PUBLIC_URL": "${SUPABASE_PUBLIC_URL}",
        "SUPABASE_ANON_KEY": "${ANON_KEY}",
        "SUPABASE_SERVICE_KEY": "${SERVICE_ROLE_KEY}",
        "LOGFLARE_API_KEY": "${LOGFLARE_API_KEY}",
        "LOGFLARE_URL": "http://analytics:4000",
        "NEXT_PUBLIC_ENABLE_LOGS": "true",
        "NEXT_ANALYTICS_BACKEND_PROVIDER": "postgres"
      },
      "depends_on": [
        "meta"
      ]
    },
    {
      "name": "db",
      "image": "supabase/postgres:15.1.0.147",
      "isMain": true,
      "environment": {
        "POSTGRES_HOST": "/var/run/postgresql",
        "PGPORT": "${POSTGRES_PORT}",
        "POSTGRES_PORT": "${POSTGRES_PORT}",
        "PGPASSWORD": "${POSTGRES_PASSWORD}",
        "POSTGRES_PASSWORD": "${POSTGRES_PASSWORD}",
        "PGDATABASE": "${POSTGRES_DB}",
        "POSTGRES_DB": "${POSTGRES_DB}",
        "JWT_SECRET": "${JWT_SECRET}",
        "JWT_EXP": "${JWT_EXPIRY}"
      },
      "volumes": [
        {
          "type": "bind",
          "source": "./volumes/db/realtime.sql",
          "target": "/docker-entrypoint-initdb.d/migrations/99-realtime.sql"
        },
        {
          "type": "bind",
          "source": "./volumes/db/webhooks.sql",
          "target": "/docker-entrypoint-initdb.d/init-scripts/98-webhooks.sql"
        },
        {
          "type": "bind",
          "source": "./volumes/db/roles.sql",
          "target": "/docker-entrypoint-initdb.d/init-scripts/99-roles.sql"
        },
        {
          "type": "bind",
          "source": "./volumes/db/jwt.sql",
          "target": "/docker-entrypoint-initdb.d/init-scripts/99-jwt.sql"
        },
        {
          "type": "bind",
          "source": "./volumes/db/data",
          "target": "/var/lib/postgresql/data"
        }
      ],
      "command": [
        "postgres",
        "-c",
        "config_file=/etc/postgresql/postgresql.conf",
        "-c",
        "log_min_messages=fatal"
      ]
    }
  ]
}